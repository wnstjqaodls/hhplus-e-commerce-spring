# 시스템 장애 대응 매뉴얼

## 1. 개요

### 1.1 문서 목적
온라인 쇼핑몰 서비스에 문제가 발생했을 때, 빠르고 체계적으로 해결하기 위한 대응 방법을 제공합니다.

### 1.2 적용 범위
- 온라인 쇼핑몰에서 발생하는 모든 시스템 문제
- 서비스 속도 저하 및 사용자 불편 상황
- 데이터 오류 및 업무 처리 문제

### 1.3 장애 심각도 분류

| 심각도 | 설명 | 해결 목표 시간 | 예시 상황 |
|---------|------|----------------|-----------|
| **최고 심각 (P0)** | 서비스 전체 중단 | 15분 이내 | 사이트 접속 불가, 전체 시스템 멈춤 |
| **높음 (P1)** | 핵심 기능 사용 불가 | 30분 이내 | 결제 안됨, 주문 처리 안됨 |
| **보통 (P2)** | 일부 기능 문제 | 2시간 이내 | 쿠폰 발급 지연, 상품 조회 느림 |
| **낮음 (P3)** | 성능 저하 | 4시간 이내 | 페이지 로딩 느림, 부가 기능 오류 |

## 2. 주요 장애 시나리오 및 대응 방안

### 2.1 분산 락 관련 장애

#### 🚨 장애 상황: Redis 분산 락 타임아웃 증가
**증상:**
- 포인트 충전/주문 결제 응답시간 급증
- "Lock acquisition timeout" 에러 로그 증가
- 사용자 대기 시간 길어짐

**진단 방법:**
```bash
# Redis 연결 상태 확인
redis-cli ping

# Redis 메모리 사용량 확인
redis-cli info memory

# 활성 락 개수 확인
redis-cli keys "MY_LOCK:*" | wc -l

# 애플리케이션 로그 확인
kubectl logs -f deployment/hhplus-app | grep "Lock acquisition"
```

**대응 절차:**
1. **즉시 대응 (5분 이내)**
   ```bash
   # 1. Redis 재시작
   kubectl restart deployment/redis

   # 2. 애플리케이션 락 타임아웃 임시 증가
   kubectl set env deployment/hhplus-app LOCK_WAIT_TIME=10

   # 3. 부하 분산을 위한 인스턴스 증설
   kubectl scale deployment/hhplus-app --replicas=5
   ```

2. **근본 원인 분석**
   - Redis 메모리 부족 여부 확인
   - 락 보유 시간이 긴 트랜잭션 식별
   - 동시 사용자 급증 여부 확인

3. **영구 해결책**
   - Redis 클러스터 구성
   - 락 키 세분화
   - 트랜잭션 범위 최소화

#### 🚨 장애 상황: 데드락 발생
**증상:**
- 데이터베이스 트랜잭션 데드락 에러
- 특정 사용자 요청이 무한 대기
- "Deadlock found when trying to get lock" 에러

**진단 방법:**
```sql
-- MySQL 데드락 로그 확인
SHOW ENGINE INNODB STATUS\G

-- 현재 실행 중인 트랜잭션 확인
SELECT * FROM information_schema.INNODB_TRX;

-- 락 대기 상황 확인
SELECT * FROM information_schema.INNODB_LOCKS;
```

**대응 절차:**
1. **즉시 대응**
   - 데드락 발생 트랜잭션 강제 종료
   - 해당 사용자 요청 재시도 안내
   - 모니터링 알람 확인

2. **복구 작업**
   - 데이터 정합성 검증
   - 실패한 거래 수동 처리
   - 사용자 보상 정책 적용

### 2.2 데이터베이스 장애

#### 🚨 장애 상황: 커넥션 풀 고갈
**증상:**
- "Connection pool exhausted" 에러
- 모든 DB 의존 API 응답 불가
- 애플리케이션 행 (Hang) 상태

**진단 방법:**
```bash
# 커넥션 풀 상태 확인
curl http://localhost:8080/actuator/metrics/hikaricp.connections.active

# DB 프로세스 리스트 확인
mysql -e "SHOW PROCESSLIST;"

# 애플리케이션 스레드 덤프
jstack <pid> > thread_dump.txt
```

**대응 절차:**
1. **응급 처치 (2분 이내)**
   ```bash
   # 애플리케이션 재시작
   kubectl restart deployment/hhplus-app

   # 커넥션 풀 크기 임시 증가
   kubectl set env deployment/hhplus-app SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE=100
   ```

2. **점검 및 복구**
   - 긴 실행 시간 쿼리 식별 및 종료
   - 커넥션 누수 발생 코드 점검
   - DB 서버 리소스 확인

#### 🚨 장애 상황: 슬로우 쿼리 급증
**증상:**
- 전체적인 응답 시간 증가
- 특정 API 타임아웃 발생
- DB CPU 사용률 급상승

**진단 방법:**
```sql
-- 슬로우 쿼리 로그 확인
SELECT * FROM mysql.slow_log ORDER BY start_time DESC LIMIT 10;

-- 현재 실행 중인 쿼리 확인
SELECT * FROM information_schema.PROCESSLIST WHERE TIME > 5;

-- 인덱스 사용률 확인
SHOW INDEX FROM orders;
EXPLAIN SELECT * FROM orders WHERE user_id = 1;
```

**대응 절차:**
1. **즉시 완화**
   - 슬로우 쿼리 강제 종료
   - 해당 기능 임시 비활성화
   - 캐시 TTL 증가로 DB 부하 감소

2. **최적화 작업**
   - 누락된 인덱스 추가
   - 쿼리 최적화
   - 파티셔닝 검토

### 2.3 캐시 장애

#### 🚨 장애 상황: Redis 캐시 서버 다운
**증상:**
- 캐시 의존 API 응답시간 급증
- "Unable to connect to Redis" 에러
- DB 부하 급증

**진단 방법:**
```bash
# Redis 서버 상태 확인
redis-cli ping

# Redis 프로세스 확인
ps aux | grep redis

# 네트워크 연결 확인
telnet redis-host 6379
```

**대응 절차:**
1. **Failover 처리**
   ```bash
   # Redis 재시작 시도
   systemctl restart redis

   # 슬레이브 서버로 전환 (구성되어 있는 경우)
   kubectl patch service redis-service -p '{"spec":{"selector":{"app":"redis-slave"}}}'

   # 캐시 없이 동작하도록 설정
   kubectl set env deployment/hhplus-app SPRING_CACHE_TYPE=none
   ```

2. **성능 보완 대책**
   - DB 커넥션 풀 임시 확장
   - 불필요한 조회 API 제한
   - CDN 캐시 TTL 증가

### 2.4 메시지 큐 (Kafka) 장애

#### 🚨 장애 상황: 쿠폰 발급 메시지 처리 지연
**증상:**
- 쿠폰 발급 요청 후 실제 발급까지 지연
- Consumer lag 급증
- "Message consumption timeout" 에러

**진단 방법:**
```bash
# Consumer lag 확인
kafka-console-consumer --bootstrap-server localhost:9092 \
  --topic coupon-issue --group hhplus-consumer-group --describe

# Topic 상태 확인
kafka-topics --bootstrap-server localhost:9092 --describe --topic coupon-issue

# Consumer 그룹 상태 확인
kafka-consumer-groups --bootstrap-server localhost:9092 --describe --group hhplus-consumer-group
```

**대응 절차:**
1. **즉시 대응**
   ```bash
   # Consumer 인스턴스 증설
   kubectl scale deployment/coupon-consumer --replicas=5

   # 파티션 수 증가 (다운타임 없이)
   kafka-topics --bootstrap-server localhost:9092 --alter --topic coupon-issue --partitions 10
   ```

2. **복구 작업**
   - 처리되지 않은 메시지 수동 처리
   - 쿠폰 발급 상태 일괄 업데이트
   - 사용자 알림 및 보상

## 3. 모니터링 및 알람

### 3.1 핵심 모니터링 지표

#### 애플리케이션 지표
```yaml
alerts:
  - name: HighResponseTime
    condition: http_request_duration_seconds{quantile="0.95"} > 1.0
    duration: 5m
    action: P1 알람 발생

  - name: HighErrorRate
    condition: http_requests_total{status=~"5.*"} / http_requests_total > 0.05
    duration: 2m
    action: P0 알람 발생

  - name: LowThroughput
    condition: http_requests_per_second < 50
    duration: 10m
    action: P2 알람 발생
```

#### 시스템 지표
```yaml
alerts:
  - name: HighCPUUsage
    condition: cpu_usage_percent > 80
    duration: 5m

  - name: HighMemoryUsage
    condition: memory_usage_percent > 85
    duration: 5m

  - name: DiskSpaceLow
    condition: disk_free_percent < 20
    duration: 1m
```

#### 비즈니스 지표
```yaml
alerts:
  - name: PaymentFailureSpike
    condition: payment_failure_rate > 0.1
    duration: 2m
    action: 즉시 결제팀 알림

  - name: CouponIssueDelay
    condition: coupon_issue_lag_seconds > 300
    duration: 5m
    action: 마케팅팀 알림
```

### 3.2 알람 채널 설정
- **P0/P1**: Slack #emergency + SMS + 전화
- **P2**: Slack #alerts + 이메일
- **P3**: Slack #monitoring + 이메일 (업무시간만)

## 4. 복구 검증 체크리스트

### 4.1 기능 검증
```bash
# 기본 헬스 체크
curl http://localhost:8080/actuator/health

# 핵심 비즈니스 기능 테스트
curl -X POST http://localhost:8080/points/charge \
  -H "Content-Type: application/json" \
  -d '{"userId": 1, "amount": 1000}'

curl -X POST http://localhost:8080/orders/order-and-pay \
  -H "Content-Type: application/json" \
  -d '{"userId": 1, "productId": 1, "quantity": 1, "amount": 10000}'
```

### 4.2 성능 검증
```bash
# 간단한 부하 테스트
k6 run --vus 10 --duration 30s smoke-test.js

# 핵심 지표 확인
curl http://localhost:8080/actuator/metrics/http.server.requests
curl http://localhost:8080/actuator/metrics/hikaricp.connections.active
```

### 4.3 데이터 정합성 검증
```sql
-- 포인트 잔액 정합성 확인
SELECT user_id, SUM(amount) as calculated_balance
FROM point_history
GROUP BY user_id
HAVING calculated_balance < 0;

-- 주문/결제 정합성 확인
SELECT o.id, o.total_amount, p.amount
FROM orders o
LEFT JOIN payments p ON o.id = p.order_id
WHERE o.status = 'COMPLETED' AND p.amount IS NULL;
```

## 5. 사후 분석 및 개선

### 5.1 장애 보고서 템플릿

#### 장애 요약
- **발생 시간**: YYYY-MM-DD HH:MM - HH:MM
- **영향 범위**: 사용자 X명, 거래량 Y건 영향
- **장애 등급**: P0/P1/P2/P3
- **복구 시간**: X분

#### 근본 원인 분석
1. **직접 원인**: 무엇이 실패했는가?
2. **근본 원인**: 왜 실패했는가?
3. **기여 요인**: 다른 어떤 요인들이 있었는가?

#### 대응 과정
- **탐지**: 언제, 어떻게 발견했는가?
- **대응**: 어떤 조치를 취했는가?
- **복구**: 어떻게 복구했는가?
- **검증**: 복구를 어떻게 확인했는가?

#### 개선 계획
- **즉시 개선**: 재발 방지를 위한 긴급 조치
- **단기 개선**: 1개월 내 완료할 개선 사항
- **장기 개선**: 구조적 개선 계획

### 5.2 예방 조치

#### 코드 리뷰 체크포인트
- [ ] 트랜잭션 범위 적절성
- [ ] 예외 처리 완전성
- [ ] 리소스 해제 확실성
- [ ] 성능 임계점 고려

#### 배포 전 체크리스트
- [ ] 부하 테스트 수행
- [ ] 장애 시나리오 테스트
- [ ] 모니터링 지표 설정
- [ ] 롤백 계획 수립

## 6. 연락처 및 에스컬레이션

### 6.1 담당자 연락처
- **시스템 관리자**: [연락처]
- **DB 관리자**: [연락처]
- **네트워크 관리자**: [연락처]
- **비즈니스 담당자**: [연락처]

### 6.2 에스컬레이션 매트릭스
| 시간 | P0 | P1 | P2 |
|------|----|----|---|
| 15분 | 팀 리더 알림 | - | - |
| 30분 | 부서장 알림 | 팀 리더 알림 | - |
| 1시간 | 임원 알림 | 부서장 알림 | 팀 리더 알림 |

### 6.3 외부 업체 연락처
- **클라우드 Provider**: [연락처]
- **CDN Provider**: [연락처]
- **모니터링 솔루션**: [연락처]

---

**📝 문서 버전**: v1.0
**📅 최종 업데이트**: 2025-09-14
**👥 작성자**: HH+ E-commerce 개발팀
**🔄 리뷰 주기**: 분기별